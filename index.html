import React, { useState, useRef } from 'react';

const App = () => {
  // 元のカラーパレットを維持
  const COLORS = {
    base: '#FFFFFF',
    sa: '#4FCFFF',   // 水色
    ya1: '#FF94F3',  // ピンク
    ma1: '#42FFF2',  // シアン
    ma2: '#B197FF',  // 紫
    ya2: '#4FCFFF'   // 水色
  };

  // 不正解時の文字色
  const MISMATCH_COLOR = '#555555';

  // ターゲットを「ﾏ」「ﾔ」「ﾀﾞ」「ﾖ」に変更
  const DIE_FACES = ['ﾏ', 'ﾔ', 'ﾀﾞ', 'ﾖ'];
  const TARGET_STRING = ['ﾏ', 'ﾔ', 'ﾀﾞ', 'ﾖ'];
  
  // ポジションごとの正解色（元の配置を維持）
  const POSITION_COLORS = [
    COLORS.ya1, // ﾏ
    COLORS.ma2, // ﾔ
    COLORS.sa,  // ﾀﾞ
    COLORS.ma1  // ﾖ
  ];

  const [dice, setDice] = useState(['？', '？', '？', '？']);
  const [isRolling, setIsRolling] = useState(false);
  const [rollCount, setRollCount] = useState(0);
  const [gameStatus, setGameStatus] = useState('idle');
  const [history, setHistory] = useState([]);
  
  const timerRef = useRef(null);

  const rollDice = () => {
    if (isRolling) return;
    
    setIsRolling(true);
    setGameStatus('rolling');
    
    let tick = 0;
    timerRef.current = setInterval(() => {
      setDice(prev => prev.map(() => DIE_FACES[Math.floor(Math.random() * DIE_FACES.length)]));
      tick++;
      
      if (tick > 6) {
        clearInterval(timerRef.current);
        timerRef.current = null;
        finalizeRoll();
      }
    }, 40);
  };

  const finalizeRoll = () => {
    const finalDice = Array(4).fill(null).map(() => 
      DIE_FACES[Math.floor(Math.random() * DIE_FACES.length)]
    );
    
    setDice(finalDice);
    
    setRollCount(prev => {
      const next = prev + 1;
      const isWin = finalDice.every((face, index) => face === TARGET_STRING[index]);
      setGameStatus(isWin ? 'won' : 'idle');
      setHistory(prevH => [{ result: finalDice.join(''), count: next, isWin: isWin }, ...prevH].slice(0, 3));
      return next;
    });

    setIsRolling(false);
  };

  const resetGame = () => {
    setDice(['？', '？', '？', '？']);
    setRollCount(0);
    setGameStatus('idle');
    setHistory([]);
  };

  const yumekawaStyle = {
    fontFamily: '"M PLUS Rounded 1c", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif',
    background: `radial-gradient(circle at 50% 50%, #ffffff 0%, #fff0fb 100%)`,
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-300" style={yumekawaStyle}>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap');`}</style>

      <div className="text-center mb-10">
        <h1 className="text-4xl md:text-5xl font-extrabold mb-4 tracking-tighter text-slate-700">
          ﾏﾔﾀﾞﾖチャレンジ
        </h1>
        <div className="flex flex-col items-center gap-1">
          <span className="text-xs font-bold text-slate-400 tracking-widest uppercase">Goal</span>
          <div className="flex justify-center gap-2 text-2xl font-black tracking-widest drop-shadow-sm">
            {TARGET_STRING.map((char, i) => (
              <span key={i} style={{ color: POSITION_COLORS[i] }}>{char}</span>
            ))}
          </div>
        </div>
      </div>

      <div className="bg-white/60 backdrop-blur-md p-8 md:p-12 rounded-[3rem] w-full max-w-2xl border-4 border-white shadow-[0_20px_50px_rgba(255,148,243,0.15)] relative">
        <div className="flex flex-wrap justify-center gap-3 md:gap-6 mb-12">
          {dice.map((face, index) => {
            const isMatch = !isRolling && face === TARGET_STRING[index];
            const charColor = isRolling ? '#ddd' : (isMatch ? POSITION_COLORS[index] : MISMATCH_COLOR);
            
            return (
              <div 
                key={index}
                className={`w-20 h-20 md:w-28 md:h-28 flex items-center justify-center text-4xl md:text-6xl font-black rounded-3xl transition-all duration-150 ${isRolling ? 'scale-90 opacity-80' : 'scale-100 opacity-100'}`}
                style={{ 
                  backgroundColor: '#FFFFFF',
                  color: charColor,
                  boxShadow: isMatch 
                    ? `0 10px 0 ${charColor}20, inset 0 -4px 0 ${charColor}10` 
                    : `0 10px 0 #f0f0f0`,
                  border: `3px solid ${isMatch ? charColor + '40' : '#f8f8f8'}`
                }}
              >
                {face}
              </div>
            );
          })}
        </div>

        <div className="flex flex-col items-center h-20">
          {gameStatus === 'won' ? (
            <button
              onClick={resetGame}
              className="px-10 py-4 rounded-full font-black text-xl text-white shadow-lg transition-all active:scale-95"
              style={{ backgroundColor: COLORS.ma2 }}
            >
              もう一度遊ぶ
            </button>
          ) : isRolling ? (
            <div className="px-14 py-5 font-black text-2xl text-slate-300 animate-pulse">
              ROLLING...
            </div>
          ) : (
            <button
              onClick={rollDice}
              className="px-14 py-5 rounded-full font-black text-2xl text-white shadow-lg transition-all transform active:scale-90 hover:brightness-105"
              style={{ 
                backgroundColor: COLORS.ya1,
                boxShadow: `0 8px 0 ${COLORS.ya1}cc`
              }}
            >
              {rollCount === 0 ? 'START' : 'ROLL'}
            </button>
          )}
        </div>

        <div className="mt-10 text-center">
          <div className="inline-block px-6 py-2 rounded-full bg-white/80 border border-pink-50">
            <span className="text-pink-300 font-black mr-2 text-xs">COUNT</span>
            <span className="text-2xl font-black text-slate-600">{rollCount}</span>
          </div>
        </div>
      </div>

      {history.length > 0 && (
        <div className="mt-8 flex flex-col gap-2 w-full max-w-xs opacity-60">
          {history.map((item, idx) => (
            <div key={idx} className="flex justify-between items-center px-4 py-1 text-xs font-bold text-slate-400">
              <span>#{item.count}</span>
              <span className="tracking-[0.3em] font-black">{item.result}</span>
              <div className={`w-2 h-2 rounded-full ${item.isWin ? 'bg-pink-400' : 'bg-slate-200'}`} />
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default App;
